# local-review

## 概要

ローカルリポジトリの変更を分析し、コードレビューを実施する。

## 実行手順

### 1. スコープの選択

```text
🔍 スコープの選択
────────────────────────────────────────
1. ▰▱▱ Quick (クイック) - セキュリティとコード品質をチェック
2. ▰▰▱ Standard (標準) - 影響範囲とテストを追加チェック
3. ▰▰▰ Full (フル) - 設計とパフォーマンスも含む全項目チェック

(1-3):
```

ユーザーが番号を選択したら以下を実行。

- 有効な番号が選択された場合
  - 選択されたスコープを記録
- 無効な番号が選択された場合
  - 「無効な番号です。もう一度番号を選択してください。」と再入力を促す

### 2. カレントブランチの確認

```bash
git branch --show-current
git status --short
```

### 3. レビュー対象の選択

#### 3.1 データ取得

```bash
git branch --format='%(refname:short)'
git status --short
```

#### 3.2 レビュー対象リストの作成

1. 取得したローカルブランチ一覧からカレントブランチを除外
1. 未コミットの変更がある場合はリストの最後に「未コミットの変更」オプションを追加

#### 3.3 レビュー対象の判定と表示

##### レビュー対象が存在しない場合

- 「選択可能な項目がありません。」と出力して処理を終了

##### レビュー対象が存在する場合

番号付きリストでブランチを出力。

```text
📌 レビュー対象の選択
────────────────────────────────────────
1. branch-name-1
2. branch-name-2
3. 未コミットの変更

(1-3):
```

#### 3.4 ユーザー選択の処理

ユーザーが番号を選択したら以下を実行。

- 有効な番号が選択された場合
  - 選択されたレビュー対象を記録
- 無効な番号が選択された場合
  - 「無効な番号です。もう一度番号を選択してください。」と再入力を促す

### 4. 差分の調査と分析

選択に応じて差分を調査し、以下の情報を収集。

#### 4.1 ローカルブランチが選択された場合

選択されたブランチとの差分を取得。

- `${selected_branch}` に <選択されたブランチ名> を設定
- `${review_target}` に <選択されたブランチ名> を設定

```bash
git diff ${selected_branch}...HEAD --stat
git diff ${selected_branch}...HEAD --name-status
git diff ${selected_branch}...HEAD --ignore-all-space --ignore-blank-lines
```

#### 4.2 未コミットの変更が選択された場合

作業ディレクトリの変更を取得。

- `${selected_branch}` は設定しない
- `${review_target}` に「未コミットの変更」を設定する

```bash
git status --short
git diff --staged --stat
git diff --staged --ignore-all-space --ignore-blank-lines
git diff --stat
git diff --ignore-all-space --ignore-blank-lines
```

#### 4.3 差分の分析

収集した差分を整理して、以下の項目に分類。

- 追加された機能
- 変更された機能
- 削除された機能

### 5. レビューの準備

以下の項目をレビュー実施前に記憶。

#### スコープ

##### Quick (クイック)

- セキュリティ
- コード品質

##### Standard (標準)

- セキュリティ
- コード品質
- 影響範囲
- テスト

##### Full (フル)

- セキュリティ
- コード品質
- 影響範囲
- テスト
- 設計・アーキテクチャ
- パフォーマンス

#### 重要度の判断基準

| 重要度 | アイコン | 説明 | 対応必要性 |
|---|---|---|---|
| Critical | 🟥 | セキュリティ脆弱性、データ損失リスク、システム停止を引き起こす問題 | 必須修正 |
| Major | 🟧 | 不具合、不足している必須機能、パフォーマンス問題 | 要対応 |
| Minor | 🟨 | コードスタイルの違反、軽微な問題 | 軽微な問題 |
| Good | 🟩 | 優れた実装、適切なエラーハンドリング、良い設計判断 | 優れた実装 |

#### レビューチェックリスト（内部参照用）

##### セキュリティ

- [ ] 入力検証とサニタイズ（XSS、SQLインジェクション、CSRF対策）
- [ ] 認証・認可の実装
- [ ] 機密情報の取り扱い（ハードコード、ログ出力、保存方法）
- [ ] 脆弱性リスク（危険な関数、古いライブラリ、既知の脆弱性）

##### コード品質

- [ ] 実装の完全性とエラーハンドリング（TODO/FIXME、エッジケース、データ型の一貫性）
- [ ] 保守性の問題（重複コード、過度な分岐・ネスト、ハードコーディング）
- [ ] 命名規則とスタイル（命名規約、コーディングスタイル、フォーマット）

##### 影響範囲

- [ ] コード変更の波及範囲（直接参照、型システム、破壊的変更）
- [ ] 外部システムへの影響（API連携、データベーススキーマ、外部サービス）
- [ ] ビルド・環境への影響（設定ファイル、環境変数、パッケージ、デプロイ）

##### テスト

- [ ] 新規・変更箇所のテスト（ユニットテスト、統合テスト、主要パス網羅）
- [ ] エッジケースのテスト（境界値、エラーケース、異常系）
- [ ] 既存テストの維持（回帰テスト、テストの破壊確認）

##### 設計・アーキテクチャ

- [ ] 設計原則と責務分離（SOLID、DRY、KISS、単一責務）
- [ ] 構造・依存関係・凝集度（レイヤー構造、循環依存、凝集度・結合度）
- [ ] 設計パターンの適切な適用（過剰/不足な抽象化の回避）

##### パフォーマンス

- [ ] 基本的な処理効率（重複計算、非効率なループ、リソース解放）
- [ ] データアクセス最適化（N+1問題、クエリ最適化、インデックス）
- [ ] 高負荷対策（キャッシュ活用、非同期・並列処理）

### 6. レビューの実行

code-reviewerエージェントを使用してレビューを実施する。

#### 基本要件

- **MUST**: code-reviewerエージェントを使用
- **MUST**: 選択されたスコープに応じたカテゴリのみを分析
- **MUST**: スコープに含まれないカテゴリはスキップ

#### エージェントへの指示要件

- **CRITICAL**: 以下の要件を必ずエージェントへの指示に含める
  - ファイル内容への言及時は必ず行番号を含める
  - 存在確認は実際に検証してから報告する
  - 不確実な場合は『おそらく』『推測では』を明記する

### 7. レビュー結果の出力

以下のルールに従って出力。

#### 出力ルール

- テンプレートの内容のみを出力する
- テキスト形式で出力する（```text```ブロックで囲む）
- レビューチェックリストは出力しない（内部参照用）
- テンプレート以外の説明や補足は追加しない
- `{{! ... }}` で囲まれた例文は出力しない（内部参照用）
- `${...}` の変数は実データで置き換える（未取得の場合は「なし」等の明示語に置換）
- `[...]` のプレースホルダはAIが適切な内容を生成して置き換える

#### 出力テンプレート

```text
🤖 レビュー結果
────────────────────────────────────────
📌 レビュー対象: ${review_target} ← ${current_branch}
📊 統計情報: [統計情報] {{! 5ファイル (+120行 -45行) }}
🔍 スコープ: [選択されたスコープ] {{! ▰▰▱ Standard }}
✅ レビュー済みカテゴリ:
  • [カテゴリ]
  {{! • セキュリティ
      • コード品質
      • 影響範囲
      • テスト }}

🟥 Critical ([総件数]) {{! 1件 }}
────────────────────────────────────────
▸ [問題タイトル] [問題カテゴリ]
  {{! SQL注入の脆弱性 [セキュリティ] }}

  [詳細な問題の説明]
  {{! user_inputを直接SQLクエリに埋め込んでおり、SQLインジェクション攻撃を受ける可能性がある }}

  📍 [ファイル名:行番号]
     {{! database.js:42 }}

🟧 Major ([総件数]) {{! 1件 }}
────────────────────────────────────────
▸ [問題タイトル] [問題カテゴリ]
  {{! N+1クエリ問題 [パフォーマンス] }}

  [詳細な問題の説明]
  {{! ループ内でデータベースクエリを実行しており、パフォーマンスが著しく低下 }}

  📍 [ファイル名:行番号]
     {{! models/user.js:89 }}

🟨 Minor ([総件数]) {{! 2件 }}
────────────────────────────────────────
▸ [問題タイトル] [問題カテゴリ]
  {{! 過度な抽象化 [設計・アーキテクチャ] }}

  [詳細な問題の説明]
  {{! 1箇所でしか使用されない抽象クラスが定義されている }}

  📍 [ファイル名:行番号]
     {{! factories/abstract.js:234 }}

▸ [問題タイトル] [問題カテゴリ]
  {{! 重複コード [コード品質] }}

  [詳細な問題の説明]
  {{! 同じ検証ロジックが複数箇所に存在している }}

  📍 [ファイル名:行番号]
     {{! utils.js:45-60, utils.js:120-135 }}

🟩 Good ([総件数]) {{! 2件 }}
────────────────────────────────────────
▸ [良い実装のタイトル]
  {{! 適切なエラーハンドリング }}

  [優れた実装の詳細説明]
  {{! try-catchブロックで全ての例外を適切に捕捉し、ユーザーフレンドリーなエラーメッセージを表示している }}

  📍 [ファイル名:行番号]
     {{! main.js:120-135 }}

▸ [良い実装のタイトル]
  {{! SOLID原則の遵守 }}

  [優れた実装の詳細説明]
  {{! 単一責務原則に従い、各クラスが明確な役割を持っている }}

  📍 [ファイル名:行番号]
     {{! services/userService.js }}
```
