# ローカルレビュー

## 概要

ローカルリポジトリ内の変更（ベースブランチとの差分、または未コミットの変更）を分析し、コードレビューを実施する対話型コマンドです。

## 実行手順

### 1. 思考レベルの選択

レビューの詳細度を選択できます。以下のオプションから番号を選択してもらってください：

```text
思考レベルを選択してください：
1. ⭐ Basic (基本) - 素早い基本的なレビュー
2. ⭐⭐ Detailed (詳細) - 詳細な分析とレビュー
3. ⭐⭐⭐ Deep (深層) - 最も詳細な多角的レビュー

選択してください:
```

- ユーザーが番号を選択したら、対応する思考レベルを記録してください
- 1-3以外が入力された場合は「無効な番号です。もう一度番号を入力してください」と再入力を促してください

### 2. 現在の状態確認

- 現在のブランチと作業状況を把握してください

```bash
# 現在のブランチを確認
git branch --show-current

# 未コミットの変更を確認
git status --short
```

### 3. レビュー対象の選択

```bash
# 1. 現在のブランチ以外のローカルブランチを取得
git branch | grep -v '^\*' | sed 's/^  //'

# 2. 未コミットの変更を確認
git status --short
```

- 他のローカルブランチまたは未コミットの変更が存在する場合：
  - 番号付きリストでレビュー対象を表示してください
  - リストの最後に「未コミットの変更」オプションを追加してください
  - ユーザーが番号を選択したら、対応する差分を調査してください（選択は排他的で、いずれか1つのみ）
    - ブランチが選択された場合: `${selected_branch}` と `${review_target}` にブランチ名を設定します
    - 「未コミットの変更」が選択された場合: `${selected_branch}` は設定せず、`${review_target}` に「未コミットの変更」を設定します
  - 候補にない番号が入力された場合は「無効な番号です。もう一度番号を入力してください」と再入力を促してください

- どちらも存在しない場合：
  - 「レビュー可能な変更がありません。」と表示して処理を終了してください

### 4. 差分の調査と分析

選択に応じて差分を調査し、以下の情報を収集してください：

#### ベースブランチが選択された場合

```bash
# 1. 差分の統計情報を取得
git diff ${selected_branch}...HEAD --stat

# 2. 変更されたファイル一覧を取得
git diff ${selected_branch}...HEAD --name-status

# 3. 実際の差分内容を取得して分析
git diff ${selected_branch}...HEAD
```

#### 「未コミットの変更」が選択された場合

```bash
# 1. 変更の統計情報を取得（レビュー対象の範囲と影響度を把握するため）
git diff --staged --stat
git diff --stat

# 2. ステージされた変更を確認
git diff --staged

# 3. ステージされていない変更を確認
git diff

# 4. 変更ファイルの一覧
git status --short
```

収集した情報をもとに、以下を理解してください：

- 現在のブランチで追加/変更された機能
- ベースブランチから分岐後の変更内容
- 未コミットの変更内容
- レビューで注意すべき変更点

### 5. レビュー観点の整理

#### レビューチェックリスト（内部参照用）

以下の観点でレビューを実施してください：

##### 重要度の判断基準

- **🟥 Critical (必須修正)**: セキュリティ脆弱性、データ損失リスク、システム停止を引き起こす問題
- **🟧 Major (要対応)**: 既存の不具合、不足している必須機能、パフォーマンス問題
- **🟨 Minor (改善提案)**: より良い実装方法の提案、コードスタイルの改善、最適化の余地
- **🟩 Good (優れた実装)**: 新たに追加された改善、適切なエラーハンドリング、良い設計判断

##### 機能の正確性

- [ ] 実装が要件を満たしているか
- [ ] エッジケースが考慮されているか
- [ ] エラーハンドリングが適切か

##### コード品質

- [ ] 命名規則に従っているか
- [ ] 重複コードはないか
- [ ] 可読性は確保されているか

##### パフォーマンス

- [ ] 不要な処理はないか
- [ ] 効率的なアルゴリズムか
- [ ] リソースの解放は適切か

##### セキュリティ

- [ ] 入力値検証が実装されているか
- [ ] 機密情報の取り扱いが適切か
- [ ] 脆弱性につながる実装はないか

##### テスト

- [ ] テストケースは十分か
- [ ] 境界値テストは含まれているか
- [ ] 既存テストは通るか

code-reviewerエージェントを使用して、レビューチェックリストの観点を含む専門的な分析を実施します。

選択された思考レベルに応じて、AIの内部的な分析深度を以下のように調整してください：

- Level 1 (Basic) を選択した場合: code-reviewerエージェントで分析後、基本的な分析深度でレビューを整理
- Level 2 (Detailed) を選択した場合: code-reviewerエージェントで分析後、詳細な分析深度でレビューを整理
- Level 3 (Deep) を選択した場合: code-reviewerエージェントで分析後、最も深い分析深度でレビューを整理

※AIが内部的に分析の深さを調整する指示です。

### 6. レビュー結果の出力

以下のルールに従って出力してください：

**出力ルール:**

- テンプレートの内容のみを出力する
- テキスト形式で出力する（```text```ブロックで囲む）
- レビューチェックリストは出力しない（内部参照用）
- テンプレート以外の説明や補足は追加しない
- 角括弧で始まる指示行（例: `[選択された…]`）は出力しない
- 「例: …」と示された例示行は実データに置き換えるか、該当がなければ出力しない
- `${...}` のプレースホルダは実データで置き換える（未取得の場合は「なし」等の明示語に置換）

**出力テンプレート:**

```text
========================================
📊 レビュー概要
========================================

[選択された思考レベルに応じて以下のいずれかを表示]
⭐ 思考モード: Basic (基本)
⭐⭐ 思考モード: Detailed (詳細)
⭐⭐⭐ 思考モード: Deep (深層)
────────────────────────────────────────

📝 変更情報
────────────────────────────────────────
• 現在のブランチ: ${current_branch}
• 対象: ${review_target}
• 変更統計: [例: 5ファイル変更（+120行、-45行）]

📋 レビュー結果サマリー
────────────────────────────────────────

▼ 重要度別の指摘事項

🟥 Critical (必須修正): [件数と概要] 例: 2件 - SQL注入の脆弱性、認証バイパス
🟧 Major (要対応): [件数と概要] 例: 3件 - エラー処理の不足、メモリリーク、非効率なループ
🟨 Minor (改善提案): [件数と概要] 例: 5件 - 命名改善、コメント追加、リファクタリング提案
🟩 Good (優れた実装): [件数と概要] 例: 4件 - 適切な抽象化、エラー処理、テストカバレッジ

🔍 詳細な指摘事項
────────────────────────────────────────

🟥 Critical Issues
[必須修正が必要な重大な問題をリスト]
例: • SQL注入の脆弱性: user_input を直接クエリに埋め込んでいる (line 42)

🟧 Major Issues
[早期対応が推奨される問題をリスト]
例: • エラー処理の不足: API呼び出し失敗時の処理がない (line 78)

🟨 Minor Suggestions
[改善提案や最適化の余地をリスト]
例: • 変数名の改善: 'data' より 'userData' の方が明確 (line 15)

🟩 Good Practices
[優れた実装や良い点をリスト]
例: • 適切なエラーハンドリング: try-catch で全ての例外を捕捉 (line 120-135)
```
