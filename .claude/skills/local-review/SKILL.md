---
name: local-review
description: ローカルリポジトリの変更を分析し、コードレビューを実施する
allowed-tools: Read, Grep, Glob, Task
disable-model-invocation: true
---

# local-review

## Context

- Current branch: !`git branch --show-current`
- Status: !`git status --short`
- Branches: !`git branch --format='%(refname:short)'`

## 概要

ローカルリポジトリの変更を分析し、コードレビューを実施する。

## 実行手順

### 1. スコープの選択

```text
🔍 スコープの選択
────────────────────────────────────────
1. Quick - セキュリティとコード品質をチェック
2. Standard - 影響範囲とテストを追加チェック
3. Full - 設計とパフォーマンスも含む全項目チェック

(1-3):
```

ユーザーが番号を選択したら以下を実行。

- 有効な番号が選択された場合
  - 選択されたスコープを記録
- 無効な番号が選択された場合
  - 「無効な番号です。もう一度番号を選択してください。」と再入力を促す

### 2. レビュー対象の選択

#### 2.1 レビュー対象リストの作成

Contextセクションを確認し、以下のリストを作成。

1. Branchesからカレントブランチを除外
2. 未コミットの変更（Status）がある場合はリストの最後に「未コミットの変更」オプションを追加

#### 2.2 レビュー対象の判定と表示

##### レビュー対象が存在しない場合

「選択可能な項目がありません。」と出力して処理を終了。

##### レビュー対象が存在する場合

番号付きリストでブランチを出力。

```text
📌 レビュー対象の選択
────────────────────────────────────────
1. branch-name-1
2. branch-name-2
3. 未コミットの変更

(1-3):
```

#### 2.3 ユーザー選択の処理

ユーザーが番号を選択したら以下を実行。

- 有効な番号が選択された場合
  - 選択されたレビュー対象を記録
- 無効な番号が選択された場合
  - 「無効な番号です。もう一度番号を選択してください。」と再入力を促す

### 3. 差分の調査と分析

選択に応じて差分を調査し、以下の情報を収集。

#### 3.1 ローカルブランチが選択された場合

選択されたブランチとの差分を取得。

- `${selected_branch}` に <選択されたブランチ名> を設定
- `${review_target}` に <選択されたブランチ名> を設定

```bash
git diff ${selected_branch}...HEAD --stat
git diff ${selected_branch}...HEAD --name-status
git diff ${selected_branch}...HEAD --ignore-all-space --ignore-blank-lines
```

#### 3.2 未コミットの変更が選択された場合

作業ディレクトリの変更を取得。

- `${selected_branch}` は設定しない
- `${review_target}` に「未コミットの変更」を設定する

```bash
git status --short
git diff --staged --stat
git diff --staged --ignore-all-space --ignore-blank-lines
git diff --stat
git diff --ignore-all-space --ignore-blank-lines
```

#### 3.3 差分の分析

収集した差分を整理して、以下の項目に分類。

- 追加された機能
- 変更された機能
- 削除された機能

### 4. レビューの準備

以下の項目をレビュー実施前に記憶。

#### スコープ

##### Quick

- セキュリティ
- コード品質

##### Standard

- セキュリティ
- コード品質
- 影響範囲
- テスト

##### Full

- セキュリティ
- コード品質
- 影響範囲
- テスト
- 設計・アーキテクチャ
- パフォーマンス

#### 重要度の判断基準

| 重要度 | アイコン | 説明 | 対応必要性 |
| --- | --- | --- | --- |
| Critical | 🟥 | セキュリティ脆弱性、データ損失リスク、システム停止を引き起こす問題 | 必須修正 |
| Major | 🟧 | 不具合、不足している必須機能、パフォーマンス問題 | 要対応 |
| Minor | 🟨 | コードスタイルの違反、軽微な問題 | 軽微な問題 |
| Good | 🟩 | 優れた実装、適切なエラーハンドリング、良い設計判断 | 優れた実装 |

#### レビューチェックリスト

[CHECKLIST.md](CHECKLIST.md) を参照

### 5. レビューの実行

code-reviewerエージェントを使用してレビューを実施する。

#### 基本要件

- **MUST**: code-reviewerエージェントを使用
- **MUST**: 選択されたスコープに応じたカテゴリのみを分析
- **MUST**: スコープに含まれないカテゴリはスキップ

#### エージェントへの指示要件

- **CRITICAL**: 以下の要件を必ずエージェントへの指示に含める
  - ファイル内容への言及時は必ず行番号を含める
  - 存在確認は実際に検証してから報告する
  - 推測や可能性による指摘は禁止（実際に確認できた問題のみ報告）

### 6. レビュー結果の出力

[TEMPLATE.md](TEMPLATE.md) を参照
