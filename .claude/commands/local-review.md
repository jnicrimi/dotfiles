# local-review

## 概要

ローカルリポジトリの変更を分析し、コードレビューを実施する

## 実行手順

### 1. 思考レベルの選択

レビューの詳細度を選択できます。以下のオプションから番号を選択してもらってください

```text
════════════════════════════════════════
🧠 思考レベルを選択
════════════════════════════════════════

1. ⭐ Basic (基本) - 素早い基本的なレビュー
2. ⭐⭐ Detailed (詳細) - 詳細な分析とレビュー
3. ⭐⭐⭐ Deep (深層) - 最も詳細な多角的レビュー

選択してください:
```

- ユーザーが番号を選択したら、対応する思考レベルを記録してください
- 1-3以外が入力された場合は「無効な番号です。もう一度番号を入力してください」と再入力を促してください

### 2. 現在の状態確認

現在のブランチと作業状況を把握してください

```bash
# 現在のブランチを確認
git branch --show-current

# 未コミットの変更を確認
git status --short
```

### 3. レビュー対象の選択

```bash
# 1. 現在のブランチ以外のローカルブランチを取得
git branch | grep -v '^\*' | sed 's/^  //'

# 2. 未コミットの変更を確認
git status --short
```

- 他のローカルブランチまたは未コミットの変更が存在する場合
  - 番号付きリストでレビュー対象を表示してください
  - リストの最後に「未コミットの変更」オプションを追加してください
  - ユーザーが番号を選択したら、対応する差分を調査してください（選択は排他的で、いずれか1つのみ）
  - 候補にない番号が入力された場合は「無効な番号です。もう一度番号を入力してください」と再入力を促してください

```text
════════════════════════════════════════
🔍 レビュー対象の選択
════════════════════════════════════════

1. branch-name-1
2. branch-name-2
3. 未コミットの変更

選択してください:
```

- どちらも存在しない場合
  - 「レビュー可能な変更がありません。」と表示して処理を終了してください

### 4. 差分の調査と分析

選択に応じて差分を調査し、以下の情報を収集してください

#### ベースブランチが選択された場合

- `${selected_branch}` に <選択されたベースブランチ名> を設定します
- `${review_target}` に 「対象のブランチ: <選択されたベースブランチ名>」を設定します

```bash
# 1. 差分の統計情報を取得
git diff ${selected_branch}...HEAD --stat

# 2. 変更されたファイル一覧を取得
git diff ${selected_branch}...HEAD --name-status

# 3. 実際の差分内容を取得して分析
git diff ${selected_branch}...HEAD
```

#### 「未コミットの変更」が選択された場合

- `${selected_branch}` は設定しません
- `${review_target}` に「対象: 未コミットの変更」を設定します

```bash
# 1. 変更の統計情報を取得（レビュー対象の範囲と影響度を把握するため）
git diff --staged --stat
git diff --stat

# 2. ステージされた変更を確認
git diff --staged

# 3. ステージされていない変更を確認
git diff

# 4. 変更ファイルの一覧
git status --short
```

収集した情報をもとに、以下を理解してください

- 現在のブランチで追加/変更された機能
- ベースブランチから分岐後の変更内容
- 未コミットの変更内容
- レビューで注意すべき変更点

### 5. レビュー実施

#### 重要度の判断基準

| 重要度 | アイコン | 説明 | 対応必要性 |
|---|---|---|---|
| Critical | 🟥 | セキュリティ脆弱性、データ損失リスク、システム停止を引き起こす問題 | 必須修正 |
| Major | 🟧 | 不具合、不足している必須機能、パフォーマンス問題 | 要対応 |
| Minor | 🟨 | コードスタイルの違反、軽微な問題 | 軽微な問題 |
| Good | 🟩 | 優れた実装、適切なエラーハンドリング、良い設計判断 | 優れた実装 |

#### レビューチェックリスト（内部参照用）

以下の観点でレビューを実施してください

##### セキュリティ

- [ ] 入力検証とサニタイズ（XSS、SQLインジェクション、CSRF対策）
- [ ] 認証・認可の実装
- [ ] 機密情報の取り扱い（ハードコード、ログ出力、保存方法）
- [ ] 脆弱性リスク（危険な関数、古いライブラリ、既知の脆弱性）

##### 設計・アーキテクチャ

- [ ] 設計原則と責務分離（SOLID、DRY、KISS、単一責務）
- [ ] 構造・依存関係・凝集度（レイヤー構造、循環依存、凝集度・結合度）
- [ ] 設計パターンの適切な適用（過剰/不足な抽象化の回避）

##### 影響範囲

- [ ] コード変更の波及範囲（直接参照、型システム、破壊的変更）
- [ ] 外部システムへの影響（API連携、データベーススキーマ、外部サービス）
- [ ] ビルド・環境への影響（設定ファイル、環境変数、パッケージ、デプロイ）

##### コード品質

- [ ] 実装の完全性とエラーハンドリング（TODO/FIXME、エッジケース、データ型の一貫性）
- [ ] 保守性の問題（重複コード、過度な分岐・ネスト、ハードコーディング）
- [ ] 命名規則とスタイル（命名規約、コーディングスタイル、フォーマット）

##### パフォーマンス

- [ ] 基本的な処理効率（重複計算、非効率なループ、リソース解放）
- [ ] データアクセス最適化（N+1問題、クエリ最適化、インデックス）
- [ ] 高負荷対策（キャッシュ活用、非同期・並列処理）

##### テスト

- [ ] 新規・変更箇所のテスト（ユニットテスト、統合テスト、主要パス網羅）
- [ ] エッジケースのテスト（境界値、エラーケース、異常系）
- [ ] 既存テストの維持（回帰テスト、テストの破壊確認）

### エージェントの使用

code-reviewerエージェントを使用して、レビューチェックリストの全カテゴリを分析します

選択された思考レベルは分析の深さを決定します

| レベル | 名称 | 分析内容 |
|---|---|---|
| Level 1 | Basic (基本) | 各カテゴリの表面的な問題を素早く検出 |
| Level 2 | Detailed (詳細) | 各カテゴリの詳細な分析と具体的な改善提案 |
| Level 3 | Deep (深層) | 各カテゴリの根本的な問題と将来的な影響まで考慮した包括的分析 |

### 6. レビュー結果の出力

以下のルールに従って出力してください

**出力ルール:**

- テンプレートの内容のみを出力する
- テキスト形式で出力する（```text```ブロックで囲む）
- レビューチェックリストは出力しない（内部参照用）
- テンプレート以外の説明や補足は追加しない
- `{{! ... }}` で囲まれた例文は出力しない（内部参照用）
- `${...}` の変数は実データで置き換える（未取得の場合は「なし」等の明示語に置換）
- `[...]` のプレースホルダはAIが適切な内容を生成して置き換える

**出力テンプレート:**

```text
════════════════════════════════════════
📊 レビュー概要
════════════════════════════════════════

思考レベル: [選択されたレベル] {{! ⭐⭐ Detailed (詳細) }}
────────────────────────────────────────

📝 変更情報
────────────────────────────────────────
• 現在のブランチ: ${current_branch}
• ${review_target}
• 変更統計: [統計情報] {{! 5ファイル変更（+120行、-45行） }}

📋 レベル別サマリー
────────────────────────────────────────

🟥 Critical Issues: [総件数] {{! 1件 }}
🟧 Major Issues: [総件数] {{! 2件 }}
🟨 Minor Issues: [総件数] {{! 3件 }}
🟩 Good Practices: [総件数] {{! 2件 }}

════════════════════════════════════════
🔍 レベル別詳細分析
════════════════════════════════════════

🟥 Critical Issues
────────────────────────────────────────

【問題カテゴリ】
{{! 【セキュリティ】}}

◆ [問題タイトル]
{{! ◆ SQL注入の脆弱性 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: database.js:42 }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: user_inputを直接SQLクエリに埋め込んでおり、SQLインジェクション攻撃を受ける可能性がある }}
• 影響範囲: [この問題による影響]
{{! • 影響範囲: データベースの不正操作、情報漏洩、データの改ざんリスク }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: プリペアドステートメントを使用するか、入力値のサニタイズを実装する }}

🟧 Major Issues
────────────────────────────────────────

【問題カテゴリ】
{{! 【パフォーマンス】}}

◆ [問題タイトル]
{{! ◆ N+1クエリ問題 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: models/user.js:89 }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: ループ内でデータベースクエリを実行しており、パフォーマンスが著しく低下 }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: JOINまたは一括クエリを使用して、クエリ回数を削減する }}

【問題カテゴリ】
{{! 【テスト】}}

◆ [問題タイトル]
{{! ◆ テストカバレッジ不足 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: services/payment.js }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: 決済処理の重要な機能にテストが存在しない }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: ユニットテストとエッジケースのテストを追加する }}

🟨 Minor Issues
────────────────────────────────────────

【問題カテゴリ】
{{! 【設計・アーキテクチャ】}}

◆ [問題タイトル]
{{! ◆ 過度な抽象化 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: factories/abstract.js:234 }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: 1箇所でしか使用されない抽象クラスが定義されている }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: 不要な抽象化を削除し、シンプルな実装に置き換える }}

【問題カテゴリ】
{{! 【コード品質】}}

◆ [問題タイトル]
{{! ◆ 重複コード }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: utils.js:45-60, utils.js:120-135 }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: 同じ検証ロジックが複数箇所に存在している }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: 共通関数として抽出し、再利用する }}

【問題カテゴリ】
{{! 【影響範囲】}}

◆ [問題タイトル]
{{! ◆ 非推奨APIの使用 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: legacy/client.js:156 }}
• 問題内容: [詳細な問題の説明]
{{! • 問題内容: 廃止予定の外部APIを使用しており、将来的に動作しなくなる可能性 }}
• 修正方法: [推奨される修正方法]
{{! • 修正方法: 新しいAPIバージョンへの移行計画を立てる }}

🟩 Good Practices
────────────────────────────────────────

◆ [良い実装のタイトル]
{{! ◆ 適切なエラーハンドリング }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: main.js:120-135 }}
• 内容: [優れた実装の詳細説明]
{{! • 内容: try-catchブロックで全ての例外を適切に捕捉し、ユーザーフレンドリーなエラーメッセージを表示している }}
• 評価理由: [なぜこれが良い実装なのか]
{{! • 評価理由: エラー時でもアプリケーションが安定して動作し、ユーザーが問題を理解しやすい }}

◆ [良い実装のタイトル]
{{! ◆ SOLID原則の遵守 }}
• ファイル: [ファイル名:行番号]
{{! • ファイル: services/userService.js }}
• 内容: [優れた実装の詳細説明]
{{! • 内容: 単一責務原則に従い、各クラスが明確な役割を持っている }}
• 評価理由: [なぜこれが良い実装なのか]
{{! • 評価理由: 保守性が高く、変更の影響範囲が限定的 }}
